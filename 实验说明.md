# Milvus向量数据库性能评估实验说明

## 1. 实验目的

本实验旨在评估Milvus向量数据库在不同索引算法下的性能表现，通过使用公开数据集测试关键性能指标，包括召回率、查询延迟、索引构建时间等。

## 2. 性能评估指标说明

### 2.1 准确率/召回率

- **定义**：搜索结果与真实结果的匹配程度。
- **计算方法**：返回的正确结果数量除以应该返回的正确结果总数。
- **意义**：评估索引算法对相似性搜索结果质量的影响。
- **理想值**：越接近1越好，表示搜索结果与真实结果完全匹配。

### 2.2 查询延迟

- **定义**：从发送查询请求到接收到结果所需的时间。
- **计算方法**：毫秒级的时间测量。
- **意义**：评估系统响应速度，对实时应用程序尤为重要。
- **理想值**：越低越好，表示查询处理速度快。

### 2.3 吞吐量

- **定义**：系统在单位时间内能处理的查询请求数量。
- **计算方法**：每秒处理的查询数（QPS）。
- **意义**：评估系统并发处理能力。
- **理想值**：越高越好，表示系统可以同时处理更多请求。

### 2.4 索引构建时间

- **定义**：创建索引所需的时间。
- **计算方法**：秒级的时间测量。
- **意义**：评估索引构建效率，影响数据导入和系统维护成本。
- **理想值**：越低越好，表示索引创建速度快。

### 2.5 资源使用

- **定义**：系统运行时对CPU、内存、存储等资源的占用情况。
- **计算方法**：CPU利用率、内存使用量、磁盘空间等指标的监控。
- **意义**：评估系统运行成本和硬件需求。
- **理想值**：越低越好，表示系统资源效率高。

## 3. 测试数据集

本实验使用SIFT（Scale-Invariant Feature Transform）数据集：
- **数据类型**：128维特征向量
- **数据规模**：
  - 基础向量集：1,000,000个向量
  - 查询向量集：10,000个向量
  - 真实结果集：每个查询的真实最近邻
- **来源**：http://corpus-texmex.irisa.fr/

## 4. 索引算法对比

本实验测试的索引算法包括：

### 4.1 FLAT (暴力搜索)
- **原理**：计算查询向量与所有基础向量之间的距离。
- **优点**：准确率100%，无需构建索引。
- **缺点**：随着数据量增加，查询延迟显著增加。
- **适用场景**：小规模数据集，对准确性要求极高的场景。

### 4.2 IVF_FLAT (倒排文件平面索引)
- **原理**：将向量空间分割成多个单元，查询时只在相关单元中搜索。
- **优点**：比FLAT快，保持较高准确率。
- **缺点**：索引构建需要时间，准确率可能略有下降。
- **关键参数**：
  - nlist：聚类中心数量
  - nprobe：搜索时考虑的聚类数量

### 4.3 IVF_SQ8 (倒排文件标量量化)
- **原理**：在IVF基础上进行8位标量量化，压缩向量存储空间。
- **优点**：减少内存使用，提高查询速度。
- **缺点**：准确率可能进一步下降。
- **关键参数**：与IVF_FLAT相同。

### 4.4 HNSW (层次可导航小世界图)
- **原理**：基于图的索引方法，构建多层次近邻图结构。
- **优点**：非常快的查询速度，高准确率。
- **缺点**：索引构建时间长，内存占用高。
- **关键参数**：
  - M：每个节点的最大出边数
  - efConstruction：构建时的搜索宽度
  - ef：搜索时的候选集大小

## 5. 实验流程

1. **环境准备**：安装依赖项，启动Milvus服务。
2. **数据准备**：下载SIFT数据集并预处理。
3. **数据导入**：将向量数据导入Milvus集合。
4. **索引构建**：分别使用不同索引算法构建索引，并记录构建时间。
5. **性能测试**：对每种索引执行向量搜索，测量延迟和召回率。
6. **结果分析**：生成性能报告，对比不同索引的优缺点。

## 6. 运行实验

### 6.0 环境要求

- Python 3.8+
- Docker 19.03+ (已支持Docker 26.1.0版本)
- pip

### 6.1 安装依赖

```bash
pip install -r requirements.txt
```

### 6.2 一键运行实验

```bash
python run_milvus_benchmark.py
```

### 6.3 运行选项

- 跳过数据下载：`--skip-download`
- 跳过Milvus启动：`--skip-milvus`
- 指定索引类型：`--indices FLAT IVF_FLAT`

### 6.4 单独运行步骤

1. 下载数据：`python scripts/download_data.py`
2. 启动Milvus：`python scripts/start_milvus.py start`
3. 运行测试：`python scripts/run_benchmark.py`
4. 停止Milvus：`python scripts/start_milvus.py stop`

## 7. 结果展示

实验结果会自动保存在`results`目录中，包括：

1. **JSON格式数据**：包含所有性能指标的详细数据。
2. **CSV格式报表**：便于导入到电子表格软件进行进一步分析。
3. **性能对比图表**：直观展示不同索引算法的性能差异。

## 8. 实验分析与结论

通过对比不同索引算法的性能指标，可以得出以下结论：

1. **准确率与速度权衡**：索引算法通常在准确率和查询速度之间做权衡。
2. **资源使用差异**：不同算法对内存和存储的需求差异显著。
3. **参数调优影响**：索引参数的选择对性能有重大影响。

根据实验结果，可以为不同应用场景推荐合适的索引算法：

- **追求绝对准确率**：使用FLAT索引。
- **大规模数据集，兼顾速度和准确率**：使用IVF_FLAT或HNSW。
- **资源受限环境**：使用IVF_SQ8或参数调优后的HNSW。
- **实时应用**：优先考虑HNSW。

## 9. 后续优化方向

1. 测试更多索引类型（如ANNOY、IVFPQ等）。
2. 测试不同参数组合对性能的影响。
3. 加入更多性能指标（如索引大小、内存占用等）。
4. 使用更大规模的数据集进行测试。
5. 测试Milvus的分布式部署性能。

## 10. 特别说明

- **Docker版本要求**: 本项目已针对Docker 26.1.0版本进行优化，使用了新版的`docker compose`命令代替旧版的`docker-compose`命令。
- **性能关注点**: 在评估过程中，特别关注了查询延迟和召回率之间的权衡，这对实际应用场景至关重要。

## 环境配置

### 软件要求

- Python 3.8+
- Docker 19.03+ (已支持Docker 26.1.0版本)
- pip

### 硬件建议

- CPU: 4核或更多
- 内存: 8GB或更多
- 硬盘: 至少10GB可用空间

## 实验步骤

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 运行基准测试

执行以下命令开始基准测试：

```bash
python run_milvus_benchmark.py
```

或者指定要测试的索引类型：

```bash
python run_milvus_benchmark.py --indices FLAT IVF_FLAT
```

如果只想进行快速验证，可以使用：

```bash
python run_milvus_benchmark.py --fast-test
```

### 3. 查看结果

测试完成后，结果将保存在`results/`目录下，包含：

- JSON格式的详细结果
- CSV格式的结果摘要
- 性能对比图表

## 常见问题解决

### 1. 数据下载问题

如果SIFT数据集下载失败，系统会自动生成一个小型示例数据集以便测试。

### 2. Docker相关问题

- 对于Docker 26.1.0版本，已更新命令为`docker compose`（无连字符）。
- 如果提示无法拉取镜像，已配置使用官方镜像源代替国内镜像源。
- 如果Milvus服务启动失败，可以尝试：
  ```bash
  docker compose -f config/docker-compose.yml down
  docker system prune -a
  ```

### 3. 连接超时问题

如果出现连接Milvus服务超时，系统已配置自动重试机制，如果仍然失败，可以增加启动后的等待时间：

```python
# 在scripts/start_milvus.py中增加等待时间
time.sleep(20)  # 增加到20秒
```

## 实验分析指南

通过对比不同索引算法的性能指标，可以得出以下结论：

1. **准确率与速度权衡**：索引算法通常在准确率和查询速度之间做权衡。
2. **资源使用差异**：不同算法对内存和存储的需求差异显著。
3. **参数调优影响**：索引参数的选择对性能有重大影响。

根据实验结果，可以为不同应用场景推荐合适的索引算法：

- **追求绝对准确率**：使用FLAT索引。
- **大规模数据集，兼顾速度和准确率**：使用IVF_FLAT或HNSW。
- **资源受限环境**：使用IVF_SQ8或参数调优后的HNSW。
- **实时应用**：优先考虑HNSW。

## 后续优化方向

1. 测试更多索引类型（如ANNOY、IVFPQ等）。
2. 测试不同参数组合对性能的影响。
3. 加入更多性能指标（如索引大小、内存占用等）。
4. 使用更大规模的数据集进行测试。
5. 测试Milvus的分布式部署性能。

## 特别说明

- **Docker版本要求**: 本项目已针对Docker 26.1.0版本进行优化，使用了新版的`docker compose`命令代替旧版的`docker-compose`命令。
- **性能关注点**: 在评估过程中，特别关注了查询延迟和召回率之间的权衡，这对实际应用场景至关重要。 